name: Build GBA ROM

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-rom:
    runs-on: ubuntu-latest
    container:
      image: devkitpro/devkitarm:latest

    steps:
      - name: Checkout game repo
        uses: actions/checkout@v4

      - name: Checkout Butano
        uses: actions/checkout@v4
        with:
          repository: GValiente/butano
          path: butano

      - name: Install host tools
        run: |
          apt-get update
          apt-get install -y --no-install-recommends ca-certificates git python3 make findutils

      - name: Setup Butano
        run: |
          set -euo pipefail
          BUTANO_PATH="$GITHUB_WORKSPACE/butano"
          rm -rf "$BUTANO_PATH"
          git clone --depth 1 https://github.com/GValiente/butano.git "$BUTANO_PATH"
          test -f "$BUTANO_PATH/tools/makefile"

      - name: Generate source assets
        run: python3 tools/gen_assets.py

      - name: Build ROM
        run: |
          BUTANO_PATH="$GITHUB_WORKSPACE/butano" make clean
          BUTANO_PATH="$GITHUB_WORKSPACE/butano" make -j2

      - name: Validate and stage ROM artifact
        run: |
          mkdir -p dist
          ROM_PATH="$(find . -maxdepth 4 -type f -name '*.gba' | head -n 1)"
          if [ -z "$ROM_PATH" ]; then
            echo "No .gba output found"
            echo "Build tree:"
            find build -maxdepth 4 -type f | sort || true
            exit 1
          fi
          cp "$ROM_PATH" dist/bangalore_love_quest.gba
          ls -lah dist

      - name: Upload ROM artifact
        uses: actions/upload-artifact@v4
        with:
          name: bangalore-love-quest-gba
          path: dist/bangalore_love_quest.gba
          if-no-files-found: error
