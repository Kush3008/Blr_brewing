name: Build GBA ROM

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-rom:
    runs-on: ubuntu-latest
    container:
      image: devkitpro/devkitarm:latest

    steps:
      - name: Checkout game repo
        uses: actions/checkout@v4

      - name: Install host tools
        run: |
          apt-get update
          apt-get install -y --no-install-recommends ca-certificates python3 make findutils

      - name: Resolve Butano path (no network)
        run: |
          set -euo pipefail
          BUTANO_PATH=""
          for candidate in "$GITHUB_WORKSPACE/butano" /opt/butano "$HOME/butano"; do
            if [ -f "$candidate/tools/makefile" ]; then
              BUTANO_PATH="$candidate"
              break
            fi
          done

          if [ -z "$BUTANO_PATH" ]; then
            echo "Could not find Butano checkout."
            echo "Expected one of:"
            echo "  - $GITHUB_WORKSPACE/butano"
            echo "  - /opt/butano"
            echo "  - $HOME/butano"
            echo "If your runners are offline, vendor Butano into the repo at ./butano."
            exit 1
          fi

          echo "Using BUTANO_PATH=$BUTANO_PATH"
          echo "BUTANO_PATH=$BUTANO_PATH" >> "$GITHUB_ENV"

      - name: Generate source assets
        run: python3 tools/gen_assets.py

      - name: Build ROM
        run: |
          make clean
          make -j2

      - name: Validate and stage ROM artifact
        run: |
          set -euo pipefail
          mkdir -p dist
          ROM_PATH=""
          if [ -f build/bangalore_love_quest.gba ]; then
            ROM_PATH="build/bangalore_love_quest.gba"
          else
            ROM_PATH="$(find build -maxdepth 5 -type f -name '*.gba' | head -n 1 || true)"
          fi

          if [ -z "$ROM_PATH" ]; then
            echo "No .gba output found"
            echo "Build tree:"
            find build -maxdepth 5 -type f | sort || true
            exit 1
          fi

          cp "$ROM_PATH" dist/bangalore_love_quest.gba
          ls -lah dist

      - name: Upload ROM artifact
        uses: actions/upload-artifact@v4
        with:
          name: bangalore-love-quest-gba
          path: dist/bangalore_love_quest.gba
          if-no-files-found: error
